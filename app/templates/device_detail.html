{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2 class="page-title">Live Network Traffic</h2>

    <input type="text" id="filterInput" placeholder="Filter requests..." oninput="filterRequests()" class="filter-input">

    <div class="log-box">
        <ul id="traffic-log" class="traffic-list"></ul>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.min.js"></script>
<script>
const socket = io();

socket.on('connect', () => {
    socket.emit('join_room', 'all');
});

socket.on('new_traffic', data => {
    const log = document.getElementById('traffic-log');
    const item = document.createElement('li');
    const time = new Date(data.timestamp * 1000).toLocaleTimeString();
    let text = `[${time}] ${data.method} ${data.path} from ${data.src_ip} to ${data.dst_ip}`;
    if(data.method === 'SNI'){
        text = `[${time}] HTTPS Domain: ${data.path} (src: ${data.src_ip})`;
    }
    item.textContent = text;
    item.setAttribute('data-text', item.textContent.toLowerCase());
    log.prepend(item);
    filterRequests();
});

function filterRequests(){
    const input = document.getElementById('filterInput').value.toLowerCase();
    const items = document.getElementById('traffic-log').children;
    for(let i=0; i<items.length; i++){
        const txt = items[i].getAttribute('data-text');
        items[i].style.display = txt.includes(input) ? 'list-item' : 'none';
    }
}
</script>
{% endblock %}
